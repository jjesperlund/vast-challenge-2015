
%% OBS: The commented code is already run, the result is saved as 3 struct matrices (friday,saturday, sunday)

%{
%% Load csv file
clc;
clear;

tic
fid = fopen( 'data/sunday.csv', 'r' );
data = textscan( fid, '%q%q%q%q%q%q',  'Delimiter',','       ...
            ,   'ReturnOnError',false, 'CollectOutput',true );
fclose( fid );
toc

%% Parse the data, save in a struct
tic

parsed_data = {};
parsed_data.timestamp = datetime(data{1,1}(2:end,1),'InputFormat','yyyy-M-dd HH:mm:ss');
parsed_data.id = str2double(data{1,1}(2:end,2));
parsed_data.type = string(data{1,1}(2:end,3));
parsed_data.xCoordinates = str2double(data{1,1}(2:end,4));
parsed_data.yCoordinates = str2double(data{1,1}(2:end,5));

toc
%}

%% Load data

load('parsed_data_friday')

%% Scatter plot of x/y coordinates
sz = 2;
scatter(parsed_data.xCoordinates,parsed_data.yCoordinates,sz)

%% Histogram of the timestamps
histogram(parsed_data.timestamp.Hour)

%% Map histogram
maxX = max(parsed_data.xCoordinates);
maxY = max(parsed_data.yCoordinates);

histogram2(parsed_data.xCoordinates, parsed_data.yCoordinates, 30,'DisplayStyle','tile','ShowEmptyBins','on', ...
    'XBinLimits',[0 maxX],'YBinLimits',[0 maxY]);
colormap hot
colorbar
grid off
axis equal
xlabel('x-coordinate')
ylabel('y-coordinate')
title('Frequency of X/Y coordinates in park map')

%% How many unique visitors are there?

[c2,~,~] = unique(parsed_data.id,'stable');
numberUnique = length(c2);
%c2 = sort(c2);

%% Sort ID 

[sorted_IDs, id_index] = sort(parsed_data.id);
parsed_data_checkin = parsed_data.type(parsed_data.type=='check-in');

%id_str = num2str(parsed_data.id);

%id_type(:,1) = parsed_data.id;
%id_type(:,2) = id_str;
%IDs = c2;

%% Create only checkin matrix
counter = 1;
for i=1:length(sorted_IDs)

    if(parsed_data.type(i) == 'check-in')
        data_checkin_coordinates(counter,1) = parsed_data.id(i);
        data_checkin_coordinates(counter,2) = parsed_data.xCoordinates(i);
        data_checkin_coordinates(counter,3) = parsed_data.yCoordinates(i);
        counter = counter + 1;
    end
    
end

%% How many checkins do every person have?

counter = 1;
data_checkin_coordinates_sorted = sortrows(data_checkin_coordinates); 
numberOfCheckin_perID = ones(numberUnique,2);

index = 1;
for i=1:(length(data_checkin_coordinates_sorted) -1)
    
    if(data_checkin_coordinates_sorted(i,1) == data_checkin_coordinates_sorted(i+1,1))
        counter = counter + 1;   
    else
        numberOfCheckin_perID(index, 1) = data_checkin_coordinates_sorted(i,1);
        numberOfCheckin_perID(index, 2) = counter;
        index = index + 1;
        counter = 1;
   end
    
end    

%% Plot number of checkins per ID

figure;
bar(numberOfCheckin_perID(:,1), numberOfCheckin_perID(:,2), 'BarWidth', 75);
max_checkins = max(numberOfCheckin_perID(:,2));
xlim([min(numberOfCheckin_perID(:,1)) max(numberOfCheckin_perID(:,1))]);
ylim([0 max_checkins]);


%% Dividing into 2 groups. Higher than 50 and lower than 10 check-ins.
counterhigh = 1;
counterlow = 1;
for i=1:index
    
    if(numberOfCheckin_perID(i,2) > 50)
        IDHighCheckin(counterhigh,1) = numberOfCheckin_perID(i,1);
        IDHighCheckin(counterhigh,2) = numberOfCheckin_perID(i,2);
        counterhigh = counterhigh + 1;
    end
    if(numberOfCheckin_perID(i,2) < 10)
        IDLowCheckin(counterlow,1) = numberOfCheckin_perID(i,1);
        IDLowCheckin(counterlow,2) = numberOfCheckin_perID(i,2);
        counterlow= counterlow + 1;       
    end
     
end



%% What Id's don't have any check-ins? 

Lia = ismember(c2,numberOfCheckin_perID(:,1));
counterzero = 1;
for i=1:length(Lia)

    if(Lia(i) == 0)
        zeroCheckin(counterzero) = c2(i);
        counterzero = counterzero + 1;
    end
    
end


%% Time analysis -- When did each person arrive and leave (duration of visit)

%% Convert timestamps to time IDs
% Using the fact that the timestamps are originally sorted in ascending order
% (1 = first arrival, 6010914 = last person to go home)

IDs_and_timestamps(:,1) = parsed_data.id;
IDs_and_timestamps(:,2) = 1:length(parsed_data.id);

%% Extract min and max timestamp and duration for each person/ID
% Constructing IDs_and_timestamps_ (date time matrix)
%              IDs_and_duration (double matrix)

% OBS: The order in the 2 constructed matrices are the same as in C2 (unique IDS). That
% is, the first row in IDs_and_timestamps correspond to the first ID in
% c2

for i = 1:length(c2)

    %Extract all timestamps for the ID: c2(i)
    specific_ID_timestamps_IDvalue = find(IDs_and_timestamps(:,1) == c2(i));
    
    %Get the actual timestamps corresponding to the ID values in specific_ID_timestamps_IDvalue 
    specific_ID_timestamps = parsed_data.timestamp(specific_ID_timestamps_IDvalue);
    
    %Store min/max timestamp (i.e. when the person arrived and left the
    %park) and duration for each unique ID
    tmin = min(specific_ID_timestamps);
    tmax = max((specific_ID_timestamps));
    IDs_and_timestamps_(i,1) = tmin;
    IDs_and_timestamps_(i,2) = tmax;
    
    % Store visit duration for each person/ID (Duration in minutes)
    specific_ID_duration = tmax - tmin;
    IDs_and_duration(i,1) = c2(i);
    IDs_and_duration(i,2) = minutes(specific_ID_duration);
end

%% 


